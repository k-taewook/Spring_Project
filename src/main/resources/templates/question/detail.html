<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/layout}">

    <th:block layout:fragment="css">
        <style>
            .fieldError {
                color: #e20b1d
            }
        </style>
    </th:block>

    <div layout:fragment="content" class="container my-3">
        <h2 th:text="${resume.subject}">상세 페이지</h2>
        <div class="card my-3 bg-warning-subtle">
            <div class="card-body">
                <div class="card-text" th:text="${resume.content}"></div>
                <div class="d-flex justify-content-end">
                    <div class="badge bg-danger text-white p-2 text-start mx-3">
                        <div class="mb-2">
                            <span th:text="${resume.author.username}"></span>
                        </div>
                        <div th:text="${#temporals.format(resume.created, 'yyyy-MM-dd HH:mm')}"></div>
                    </div>
                </div>
                <!-- 수정 / 삭제 -->
                <div>
                    <a th:href="@{|/resume/modify/${resume.id}|}"
                       class="btn btn-sm btn-outline-primary"
                       sec:authorize="isAuthenticated()"
                       th:if="${resume.author != null and #authentication.getPrincipal().getUsername() == resume.author.username}"
                    >
                        수정
                    </a>
                    <a href="javascript:void(0)"
                       th:data-uri="@{|/resume/delete/${resume.id}|}"
                       class="delete btn btn-sm btn-outline-danger"
                       sec:authorize="isAuthenticated()"
                       th:if="${resume.author != null and #authentication.getPrincipal().getUsername() == resume.author.username}"
                    >
                        삭제
                    </a>
                </div>
            </div>
        </div>

        <h5 class="border-bottom my-3 py-2" th:text="|${#lists.size(resume.answerList)} 개의 답변이 있습니다.|"></h5>

        <div class="card my-3 bg-success-subtle" th:each="answer : ${resume.answerList}">
            <div class="card-body">
                <div class="card-text" th:text="${answer.content}"></div>
                <div class="d-flex justify-content-end">
                    <div class="badge bg-success text-light p-2 text-start mx-3">
                        <div class="mb-2">
                            <span th:text="${answer.author.username}"></span>
                        </div>
                        <div th:text="${#temporals.format(answer.created, 'yyyy-MM-dd HH:mm')}"></div>
                    </div>
                </div>
                <!-- 수정 / 삭제 -->
                <div>
                    <a th:href="@{|/answer/modify/${answer.id}|}"
                       class="btn btn-sm btn-outline-primary"
                       sec:authorize="isAuthenticated()"
                       th:if="${answer.author != null and #authentication.getPrincipal().getUsername() == answer.author.username}"
                    >
                        수정
                    </a>
                    <a href="javascript:void(0)"
                       th:data-uri="@{|/answer/delete/${answer.id}|}"
                       class="delete btn btn-sm btn-outline-danger"
                       sec:authorize="isAuthenticated()"
                       th:if="${answer.author != null and #authentication.getPrincipal().getUsername() == answer.author.username}"
                    >
                        삭제
                    </a>
                </div>
            </div>
        </div>

        <!--    변수면 $, 아니면 @-->
        <form th:object="${answerDto}" class="my-3" th:action="@{|/answer/create/${resume.id}|}" method="post">
            <textarea sec:authorize="isAnonymous()" disabled class="form-control" th:field="*{content}" rows="7"></textarea>
            <textarea sec:authorize="isAuthenticated()" class="form-control" th:field="*{content}" rows="7"></textarea>
            <p class="fieldError" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">error</p>
            <input class="btn btn-primary my-3" type="submit" value="답변 등록">
        </form>
    </div>
    <th:block layout:fragment="script">
        <script type="text/javascript">
            $(() =>  {
                $('.delete').click(function(){
                    if(confirm("정말 삭제할까요?")) {
                        const uri = $(this).data('uri');
                        window.location.href = uri;
                    }
                });
            })
        </script>
    </th:block>
</html>