<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/layout}">

    <th:block layout:fragment="css">
        <style>
            .fieldError {
                color: #e20b1d
            }
        </style>
    </th:block>

    <div layout:fragment="content" class="container my-3">
        <h2 th:text="${resume.subject}">상세 페이지</h2>
        <div class="card my-3 bg-warning-subtle">
            <div class="card-body">
                <div class="mb-3">
                    <span class="badge bg-info text-dark" th:if="${resume.targetCompany != null}" th:text="|목표 기업: ${resume.targetCompany}|"></span>
                    <span class="badge bg-secondary" th:if="${resume.status != null}" th:text="|상태: ${resume.status.description}|"></span>
                </div>
                <div class="card-text" th:text="${resume.content}" style="white-space: pre-line;"></div>
                
                <div class="my-3" th:if="${resume.file != null}">
                    <label class="form-label fw-bold">첨부 파일:</label>
                    <a th:href="@{|/resume/download/${resume.id}|}" class="btn btn-sm btn-outline-dark" th:text="${resume.file.originalFileName}"></a>
                </div>

                <div class="d-flex justify-content-end">
                    <div class="badge bg-danger text-white p-2 text-start mx-3">
                        <div class="mb-2">
                            <span th:text="${resume.author.username}"></span>
                        </div>
                        <div th:text="${#temporals.format(resume.created, 'yyyy-MM-dd HH:mm')}"></div>
                    </div>
                </div>
                <!-- 수정 / 삭제 -->
                <div>
                    <a th:href="@{|/resume/modify/${resume.id}|}"
                       class="btn btn-sm btn-outline-primary"
                       sec:authorize="isAuthenticated()"
                       th:if="${resume.author != null and (#authentication.getPrincipal().getUsername() == resume.author.username or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
                    >
                        수정
                    </a>
                    <a href="javascript:void(0)"
                       th:data-uri="@{|/resume/delete/${resume.id}|}"
                       class="delete btn btn-sm btn-outline-danger"
                       sec:authorize="isAuthenticated()"
                       th:if="${resume.author != null and (#authentication.getPrincipal().getUsername() == resume.author.username or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
                    >
                        삭제
                    </a>
                </div>
            </div>
        </div>

        <h5 class="border-bottom my-3 py-2" th:text="|${#lists.size(resume.feedbackList)} 개의 첨삭 피드백이 있습니다.|"></h5>

        <div class="card my-3 bg-success-subtle" th:each="feedback : ${resume.feedbackList}">
            <div class="card-body">
                <div class="mb-2" th:if="${feedback.rating != null}">
                    <span class="badge bg-warning text-dark" th:text="|점수: ${feedback.rating}점|"></span>
                </div>
                <div class="card-text" th:text="${feedback.content}" style="white-space: pre-line;"></div>
                <div class="d-flex justify-content-end">
                    <div class="badge bg-success text-light p-2 text-start mx-3">
                        <div class="mb-2">
                            <span th:text="${feedback.author.username}"></span>
                        </div>
                        <div th:text="${#temporals.format(feedback.created, 'yyyy-MM-dd HH:mm')}"></div>
                    </div>
                </div>
                <!-- 수정 / 삭제 -->
                <div>
                    <a th:href="@{|/feedback/modify/${feedback.id}|}"
                       class="btn btn-sm btn-outline-primary"
                       sec:authorize="isAuthenticated()"
                       th:if="${feedback.author != null and (#authentication.getPrincipal().getUsername() == feedback.author.username or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
                    >
                        수정
                    </a>
                    <a href="javascript:void(0)"
                       th:data-uri="@{|/feedback/delete/${feedback.id}|}"
                       class="delete btn btn-sm btn-outline-danger"
                       sec:authorize="isAuthenticated()"
                       th:if="${feedback.author != null and (#authentication.getPrincipal().getUsername() == feedback.author.username or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
                    >
                        삭제
                    </a>
                </div>
            </div>
        </div>

        <!--    변수면 $, 아니면 @-->
        <form th:object="${feedbackDto}" class="my-3" th:action="@{|/feedback/create/${resume.id}|}" method="post">
            <div class="mb-3">
                <label for="content" class="form-label">내용</label>
                <textarea sec:authorize="isAnonymous()" disabled class="form-control" th:field="*{content}" rows="7"></textarea>
                <textarea sec:authorize="isAuthenticated()" class="form-control" th:field="*{content}" rows="7"></textarea>
                <p class="fieldError" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">error</p>
            </div>
            <div class="mb-3" sec:authorize="isAuthenticated()">
                <label for="rating" class="form-label">점수 (1~5)</label>
                <input type="number" class="form-control" th:field="*{rating}" min="1" max="5">
            </div>
            <input class="btn btn-primary my-3" type="submit" value="첨삭 등록">
        </form>
    </div>
    <th:block layout:fragment="script">
        <script type="text/javascript">
            $(() =>  {
                $('.delete').click(function(){
                    if(confirm("정말 삭제할까요?")) {
                        const uri = $(this).data('uri');
                        window.location.href = uri;
                    }
                });
            })
        </script>
    </th:block>
</html>