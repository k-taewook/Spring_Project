<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<div layout:fragment="content" class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-primary text-white p-4 rounded-top-3">
                    <h3 class="mb-0 fw-bold">
                        <i class="bi bi-file-earmark-person-fill me-2"></i>
                        <span th:text="${resumeDto.id != null ? '이력서 수정 (새 버전 생성)' : '새 이력서 작성'}">이력서 작성</span>
                    </h3>
                    <p class="mb-0 mt-2 opacity-75" th:if="${resumeDto.id != null}">
                        수정 사항은 새로운 버전으로 저장되어 히스토리로 관리됩니다.
                    </p>
                </div>
                <div class="card-body p-5 bg-light">
                    <form method="post" th:object="${resumeDto}" enctype="multipart/form-data" class="needs-validation" novalidate>
                        
                        <!-- 기본 정보 섹션 -->
                        <h5 class="text-primary mb-3 border-bottom pb-2"><i class="bi bi-info-circle me-2"></i>기본 정보</h5>
                        
                        <div class="mb-4">
                            <label for="subject" class="form-label fw-bold">지원 분야 / 제목 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg" id="subject" name="subject" th:field="*{subject}" placeholder="예: 2024년 상반기 공채 지원 - 홍길동">
                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('subject')}" th:errors="*{subject}">제목을 입력해주세요.</div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="targetCompany" class="form-label fw-bold">지원 목표 기업</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-building"></i></span>
                                    <input type="text" class="form-control" id="targetCompany" name="targetCompany" th:field="*{targetCompany}" placeholder="예: 삼성전자, 네이버">
                                </div>
                            </div>
                            <div class="col-md-6" th:if="${resumeDto.status != null}">
                                <label for="status" class="form-label fw-bold">진행 상태</label>
                                <select class="form-select" id="status" name="status" th:field="*{status}">
                                    <option value="WAITING">요청중 (첨삭 대기)</option>
                                    <option value="COMPLETED">첨삭완료</option>
                                </select>
                            </div>
                        </div>

                        <!-- 자기소개서 본문 섹션 -->
                        <h5 class="text-primary mb-3 border-bottom pb-2 mt-5"><i class="bi bi-file-text me-2"></i>자기소개서 본문</h5>
                        
                        <div class="mb-4">
                            <textarea class="form-control" id="content" name="content" th:field="*{content}" rows="15" placeholder="자기소개서 내용을 자유롭게 작성해주세요."></textarea>
                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">내용을 입력해주세요.</div>
                        </div>

                        <!-- 파일 첨부 섹션 -->
                        <h5 class="text-primary mb-3 border-bottom pb-2 mt-5"><i class="bi bi-paperclip me-2"></i>첨부 파일</h5>
                        
                        <div class="mb-4">
                            <div class="card bg-white border-secondary border-opacity-25">
                                <div class="card-body">
                                    <label for="resumeFile" class="form-label fw-bold">포트폴리오 또는 이력서 파일 (PDF, Word 등)</label>
                                    <input type="file" class="form-control" id="resumeFile" name="resumeFile">
                                    <div class="form-text text-muted">
                                        <i class="bi bi-info-circle-fill"></i> 지원 가능한 형식: .pdf, .docx, .hwp, .zip
                                    </div>
                                    
                                    <div th:if="${resumeDto.originalFileName != null}" class="alert alert-info mt-3 d-flex align-items-center" role="alert">
                                        <i class="bi bi-file-earmark-check-fill fs-4 me-2"></i>
                                        <div>
                                            <strong>현재 등록된 파일:</strong> 
                                            <span th:text="${resumeDto.originalFileName}">filename.pdf</span>
                                            <div class="small text-muted mt-1">새 파일을 업로드하면 기존 파일은 대체됩니다.</div>
                                        </div>
                                    </div>

                                    <!-- Progress Bar -->
                                    <div id="progress-container" class="mt-3" style="display: none;">
                                        <div class="progress" style="height: 20px;">
                                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                        <div class="text-center mt-1 small text-muted">파일 업로드 중...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 커밋 메시지 (수정 시에만 표시) -->
                        <div class="card bg-warning bg-opacity-10 border-warning mb-4" th:if="${resumeDto.id != null}">
                            <div class="card-body">
                                <h5 class="card-title text-warning-emphasis fw-bold"><i class="bi bi-git me-2"></i>변경 사항 기록 (Commit Message)</h5>
                                <div class="mb-3">
                                    <label for="commitMessage" class="form-label">이번 버전의 주요 변경 내용을 요약해주세요.</label>
                                    <input type="text" class="form-control border-warning" id="commitMessage" name="commitMessage" th:field="*{commitMessage}" placeholder="예: 1번 항목 경험 서술 보완, 오타 수정">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-5">
                            <a th:href="@{/resume/list}" class="btn btn-secondary btn-lg px-4">취소</a>
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i class="bi bi-save me-2"></i>저장하기
                            </button>
                        </div>
                        
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.querySelector('form').addEventListener('submit', function(e) {
            var fileInput = document.getElementById('resumeFile');
            // 파일이 있거나, 폼이 유효한 경우 (여기서는 간단히 파일 업로드 UX만 처리)
            if (fileInput.files.length > 0) {
                e.preventDefault(); // 기본 제출 막기
                
                var formData = new FormData(this);
                var xhr = new XMLHttpRequest();
                var progressBar = document.getElementById('progress-bar');
                var progressContainer = document.getElementById('progress-container');
                var submitBtn = document.getElementById('submitBtn');

                progressContainer.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 저장 중...';

                xhr.open('POST', this.action, true);

                // 진행 상태 이벤트 리스너
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = Math.round(percentComplete) + '%';
                        progressBar.setAttribute('aria-valuenow', percentComplete);
                    }
                };

                // 완료 시 처리
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        // 리다이렉트 처리
                        if (xhr.responseURL && xhr.responseURL !== window.location.href) {
                             window.location.href = xhr.responseURL;
                        } else {
                             document.open();
                             document.write(xhr.responseText);
                             document.close();
                        }
                    } else {
                        alert('업로드 중 오류가 발생했습니다.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>저장하기';
                        progressContainer.style.display = 'none';
                    }
                };

                xhr.onerror = function() {
                    alert('네트워크 오류가 발생했습니다.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>저장하기';
                    progressContainer.style.display = 'none';
                };

                xhr.send(formData);
            }
        });
    </script>
</div>
</html>